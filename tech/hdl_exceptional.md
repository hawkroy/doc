## Overview

总结一些HDL设计中两种经常使用的HDL语言：VHDL和Verilog经常困扰大家的一些问题、备忘和陷阱的提醒。通篇主要以Verilog为主，辅助讨论一些VHDL的问题。

------

## HDL的作用

HDL作为硬件电路的构造性**描述语言**，与通常的软件编程语言有很大的不同，主要体现在如下几个方面：

- 语言自身带有concurrency特性，执行时带有concurrency的并发特性，有时钟的概念，反应对应的电路物理结构；软件编程语言自身是顺序描述的，只描述逻辑的顺序结构，执行时没有并发，更多的并发支持是语言外的库的支持

- 可以在不同的水平上对于电路的行为和结构进行描述，最终，语言的产出是**电路结构**；而软件编程语言描述的逻辑的结构，产出的是**计算机识别的逻辑结构**

- 工程的处理流程上的区别

  硬件的工程主要分为三个阶段：

  - 前仿真阶段：是使用仿真器对语言描述的电路行为首先进行逻辑上的仿真，期望达到正确的逻辑功能
  - 综合阶段：相当于软件的编译行为，将描述的电路行为转换为实际的电路物理结构；转换的过程可能并不能反映设计者的真实意图(可能会与仿真结果存在冲突)或是语言特性无法生成对应的电路结构。所以，在实际的工程中，综合支持的语言特性远远少于前仿真可以使用的语言特性(**可综合语言子集**)，综合出的代码必须保证与前仿真在功能上的等价性(**形式化验证**)。所以，对于硬件描述语言，仿真和综合是两个事情。与软件编程语言的编译、执行是不同的概念(软件的编译、执行是一体的，仅仅是对表达的逻辑做了逻辑变换)；而硬件仿真反映的是逻辑的正确性，综合是在逻辑正确性基础上，在实际物理限制下做的电路结构的逻辑变换(变换后，实现的逻辑功能在有时序约束下可能等价，要考虑后仿真的效果)
  - 后仿真阶段：硬件综合后，会成为真正带有逻辑功能的电路结构。这些电路结构在不同的时序约束上可能会表现出和前仿真不一样的执行结果，所以必须重新调整硬件描述语言的组织结构使得这种物理约束可以反应在电路行为的描述上。这个过程中使用实际电路时序约束+语言描述的电路行为再进行仿真，从而检查约束下是否依然可以获得正确的逻辑结果，这个过程有时也被称为**SDF仿真**(SDF文件记录了电路的延时结构)

  软件的工程相对来说，要简单和直接的多：总是经过编译，执行的过程；过程中只需考虑逻辑变换的正确性，而不需考虑其他任何的约束条件

从上面的对比也可以看出，HDL不仅需要定义变量、功能描述之类的基础语法，还要定义描述硬件结构、连接关系的语法，还有并行化语义的语法，这些构成了HDL与软件编程语言最大的不同。但是随着综合器(Synthesis)的发展，HDL的描述能力在逐步的提高，更多的硬件设计无需从电路结构设计开始，而仅仅需要描述实际电路的功能和时序即可(**行为描述**，相关的描述必须符合综合器的规范)。

传统的HDL需要支持硬件如下3个层次的设计需求：

- 行为级描述(Behaviour-Level model)

  行为级仅仅定义硬件的功能和时序，但不描述电路结构。这种实现方式开发方便，但是严重依赖于综合器的能力。目前，大部分HDL代码都是采用这个级别进行描述。这个级别的代码可以大体上进行性能的评估，但是不能进行电路结构和功耗、面级的评估。相对于软件人员来说，这级HDL比较友好，便于理解设计者的逻辑结构

- 寄存器传输级描述(Register-Transfer-Level model)

  将硬件的功能通过D-触发器和"逻辑物理线"(wire)的电路连接方式进行描述。在这级描述中，更加关注的是时序电路与组合电路间的划分，即通过D-触发器的加入，增加的

- 门级描述(Gate-Level model)

